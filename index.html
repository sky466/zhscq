<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>账号与姓名生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="style.css">
    <style>
        body { background: url('images/456.jpg') no-repeat center center fixed; background-size: cover; }
        .result-display { background-color: rgba(255, 255, 255, 0.4); border: 2px dashed rgba(67, 97, 238, 0.4); text-align: center; padding: 10px; font-size: 1.2em; min-height: 50px; display: flex; align-items: center; justify-content: center; margin-top:15px; }
        .card { background-color: rgba(255, 255, 255, 0.8); margin-bottom: 20px; }
        .form-text { display: block; margin-top: 5px; font-size: 12px; color: #666; }
        .header-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #fff; object-fit: cover; cursor: pointer; transition: transform 0.2s; }
        .header-avatar:hover { transform: scale(1.1); }
        #user-email-display { align-items: center; gap: 10px; }
        .user-info-list { list-style: none; padding: 0; margin: 0; }
        .user-info-list li { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #eee; }
        .user-info-list li:last-child { border-bottom: none; }
        .user-info-list span:first-child { font-weight: bold; }
        #avatar-url-input { flex-grow: 1; margin: 0 10px; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        #save-avatar-url-btn { padding: 5px 10px; font-size: 12px; }
        .main-section > .card { margin-bottom: 20px; }
        .options-panel { padding-top: 15px; border-top: 1px solid #eee; margin-top: 15px;
         font-weight: bold; 		}
    </style>
</head>
<body>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

    <script>
      const firebaseConfig = { apiKey: "AIzaSyA6Id42iZITEg8pJOLzStOEtkGC_dLzrAI", authDomain: "zhscq-4c41f.firebaseapp.com", projectId: "zhscq-4c41f", storageBucket: "zhscq-4c41f.firebasestorage.app", messagingSenderId: "42819281338", appId: "1:42819281338:web:7a7d6096e70e3a1d63fd83" };
      firebase.initializeApp(firebaseConfig);
      const auth = firebase.auth();
      const db = firebase.firestore();
    </script>

    <div class="container">
        <header>
            <div class="logo"><i class="fas fa-user-circle"></i> <span>账号与姓名生成器</span></div>
            <div class="user-info">
                <div class="points" id="user-email-display" style="cursor: pointer; display: none;">
                    <img id="header-avatar" class="header-avatar" alt="Avatar">
                    <span id="user-email-text"></span>
                </div>
                <div class="points"><i class="fas fa-coins"></i> <span id="points-counter">0</span> 积分</div>
                <button class="btn btn-success" id="checkin-btn"><i class="fas fa-calendar-check"></i>每日签到</button>
                <button class="btn btn-light" id="login-btn"><i class="fas fa-sign-in-alt"></i>登录</button>
            </div>
        </header>
        
        <div class="main-content center-content">
             <div class="main-section">
                <!-- --- UNIFIED SETTINGS CARD --- -->
                <div class="card">
                    <h2 class="card-title"><i class="fas fa-cogs"></i> 生成设置</h2>
                    
                    <div class="form-group">
                        <label>生成类型:</label>
                        <div class="checkbox-group">
                            <label class="checkbox-item"><input type="radio" name="generation-type" value="account" checked> 账号</label>
                            <label class="checkbox-item"><input type="radio" name="generation-type" value="name"> 姓名</label>
                        </div>
                    </div>
                    
                    <div class="options-panel">
                        <!-- Account Options -->
                        <div id="account-options">
                            <div class="form-group"><label>账号类型:</label><div class="checkbox-group"><label class="checkbox-item"><input type="checkbox" id="chinese" checked> 中文</label><label class="checkbox-item"><input type="checkbox" id="english"> 英文</label><label class="checkbox-item"><input type="checkbox" id="numbers"> 数字</label></div></div>
                            <div class="form-group" id="account-batch-container"><label for="batch-count">批量生成数量:</label><div class="input-group"><input type="number" id="batch-count" min="1" max="20" value="5"><button class="btn btn-primary" id="batch-generate">批量</button></div></div>
                        </div>
                        
                        <!-- Name Options -->
                        <div id="name-options" style="display: none;">
                            <div class="form-group">
                                <label>姓名类型:</label>
                                <div class="checkbox-group">
                                    <label class="checkbox-item"><input type="checkbox" id="name-male" checked> 男性</label>
                                    <label class="checkbox-item"><input type="checkbox" id="name-female"> 女性</label>
                                    <label class="checkbox-item"><input type="checkbox" id="name-single" checked> 单字</label>
                                    <label class="checkbox-item"><input type="checkbox" id="name-double"> 双字</label>
                                </div>
                            </div>
                            <div class="form-group" id="name-batch-container">
                                <label for="name-batch-count">批量生成数量:</label>
                                <div class="input-group">
                                    <input type="number" id="name-batch-count" min="1" max="20" value="5">
                                    <button class="btn btn-primary" id="name-batch-generate">批量</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="result-display" id="result-display">生成结果将显示在此处</div>
                    <div class="actions">
                        <button class="btn btn-primary" id="generate-btn"><i class="fas fa-magic"></i>生成</button>
                        <button class="btn btn-danger" id="favorite-btn" disabled><i class="far fa-heart"></i>收藏</button>
                        <button class="btn btn-warning" id="copy-btn"><i class="fas fa-copy"></i>复制</button>
                    </div>
                </div>
                
                <div class="card" id="batch-results" style="display: none;"><h2 class="card-title"><i class="fas fa-list"></i>批量生成结果</h2><div class="generated-accounts" id="generated-accounts"></div><div class="actions"><button class="btn btn-primary" id="copy-all-btn"><i class="fas fa-copy"></i>复制全部</button><button class="btn btn-light" id="close-batch">关闭</button></div></div>
            </div>
            <div class="sidebar"><div class="card"><div class="tabs"><div class="tab active" data-tab="history">历史记录</div><div class="tab" data-tab="favorites">我的收藏</div></div><div class="tab-content active" id="history-content"><ul class="history-list" id="history-list"></ul><div class="actions"><button class="btn btn-light" id="clear-history"><i class="fas fa-trash"></i>清空历史</button></div></div><div class="tab-content" id="favorites-content"><ul class="history-list" id="favorites-list"></ul><div class="actions"><button class="btn btn-light" id="clear-favorites"><i class="fas fa-trash"></i>清空收藏</button></div></div></div></div>
        </div>
    </div>
    
    <div class="modal" id="auth-modal"><div class="modal-content"><div class="modal-header"><h3 id="modal-title">用户登录</h3><button class="close-modal">×</button></div><div class="modal-body"><div class="form-group"><label for="username">邮箱</label><input type="text" id="username" placeholder="输入邮箱"><small class="form-text">请使用邮箱注册</small></div><div class="form-group"><label for="password">密码</label><input type="password" id="password" placeholder="输入密码"></div><div class="form-group" id="confirm-password-group" style="display: none;"><label for="confirm-password">确认密码</label><input type="password" id="confirm-password" placeholder="再次输入密码"></div></div><div class="modal-footer"><button class="btn btn-light" id="switch-mode">注册新账号</button><button class="btn btn-primary" id="auth-submit">登录</button></div></div></div>
    
    <div class="modal" id="user-info-modal"><div class="modal-content"><div class="modal-header"><h3>用户信息</h3><button class="close-modal">×</button></div><div class="modal-body"><ul class="user-info-list"><li><span>用户邮箱</span><span id="user-email"></span></li><li><span>注册日期</span><span id="user-join-date"></span></li><li><span>当前积分</span><span id="user-points"></span></li><li><span>头像链接</span><input type="url" id="avatar-url-input" placeholder="粘贴图片链接"><button id="save-avatar-url-btn" class="btn btn-primary"><i class="fas fa-save"></i></button></li></ul></div></div></div>
    
    <div class="notification" id="notification"><i class="fas fa-check-circle"></i><span id="notification-text">操作成功</span></div>
    
    <script>
        // --- CORRECTED URLs ---
        const CHINESE_WORDS_URL = 'https://raw.githubusercontent.com/sky466/zhscq/main/chinese-words.json';
        const ENGLISH_WORDS_URL = 'https://raw.githubusercontent.com/sky466/zhscq/main/english-words.json';
        const FEMALE_NAME_URL = 'https://raw.githubusercontent.com/sky466/zhscq/refs/heads/main/Female-name.json';
        const MALE_NAME_URL = 'https://raw.githubusercontent.com/sky466/zhscq/refs/heads/main/Male-name.json';
        const FAMILY_NAME_URL = 'https://raw.githubusercontent.com/sky466/zhscq/refs/heads/main/family-name.json';

        const DEFAULT_CHINESE_WORDS = ["王者", "荣耀", "英雄", "联盟", "和平", "精英", "无畏", "契约"];
        const DEFAULT_ENGLISH_WORDS = ["Alpha", "Bravo", "Charlie", "Delta", "Echo", "Foxtrot", "Golf"];
        const DEFAULT_AVATAR_SVG = "data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%236c757d'%3E%3Cpath d='M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z'/%3E%3C/svg%3E";
        
        const DEFAULT_FAMILY_NAMES = ['赵', '钱', '孙', '李', '周', '吴', '郑', '王', '张', '陈', '刘', '杨'];
        const DEFAULT_MALE_NAMES = ['伟', '强', '磊', '军', '勇', '杰', '涛', '明', '博', '宇', '豪', '轩'];
        const DEFAULT_FEMALE_NAMES = ['芳', '秀', '娜', '静', '丽', '敏', '艳', '萍', '婷', '雪', '梅', '琳'];
        const PLACEHOLDER_TEXT = '生成结果将显示在此处';

        let currentUser = null, history = [], favorites = [], chineseWords = [], englishWords = [], femaleNames = [], maleNames = [], familyNames = [];
        
        const recentlyUsed = {};
        const RECENT_LIST_SIZE = 5;

        const dom = {
            pointsCounter: document.getElementById('points-counter'), checkinBtn: document.getElementById('checkin-btn'), loginBtn: document.getElementById('login-btn'),
            generateBtn: document.getElementById('generate-btn'), favoriteBtn: document.getElementById('favorite-btn'), copyBtn: document.getElementById('copy-btn'),
            resultDisplay: document.getElementById('result-display'), historyList: document.getElementById('history-list'),
            favoritesList: document.getElementById('favorites-list'), clearHistoryBtn: document.getElementById('clear-history'), clearFavoritesBtn: document.getElementById('clear-favorites'),
            authModal: document.getElementById('auth-modal'), switchModeBtn: document.getElementById('switch-mode'), authSubmitBtn: document.getElementById('auth-submit'),
            notification: document.getElementById('notification'), notificationText: document.getElementById('notification-text'),
            batchResults: document.getElementById('batch-results'), generatedAccounts: document.getElementById('generated-accounts'), copyAllBtn: document.getElementById('copy-all-btn'),
            closeBatchBtn: document.getElementById('close-batch'),
            
            // Account options
            chineseCheckbox: document.getElementById('chinese'), englishCheckbox: document.getElementById('english'),
            numbersCheckbox: document.getElementById('numbers'), batchCountInput: document.getElementById('batch-count'),
            batchGenerateBtn: document.getElementById('batch-generate'),
            accountBatchContainer: document.getElementById('account-batch-container'),

            // Name options
            nameMaleCheckbox: document.getElementById('name-male'), nameFemaleCheckbox: document.getElementById('name-female'),
            nameSingleCheckbox: document.getElementById('name-single'), nameDoubleCheckbox: document.getElementById('name-double'),
            nameBatchCountInput: document.getElementById('name-batch-count'),
            nameBatchGenerateBtn: document.getElementById('name-batch-generate'),
            nameBatchContainer: document.getElementById('name-batch-container'),

            // Containers
            userEmailDisplay: document.getElementById('user-email-display'), userEmailText: document.getElementById('user-email-text'),
            userInfoModal: document.getElementById('user-info-modal'), headerAvatar: document.getElementById('header-avatar'),
            avatarUrlInput: document.getElementById('avatar-url-input'), saveAvatarUrlBtn: document.getElementById('save-avatar-url-btn'),
            accountOptions: document.getElementById('account-options'), nameOptions: document.getElementById('name-options'),
            generationTypeRadios: document.querySelectorAll('input[name="generation-type"]')
        };
        
        async function init() {
            await loadWordLibraries();
            auth.onAuthStateChanged(async user => {
                if (user) {
                    currentUser = { uid: user.uid, email: user.email };
                    await loadRemoteData();
                } else {
                    currentUser = null;
                    resetLocalData();
                }
                updateUI();
            });
            setupEventListeners();
        }
        
        function updateUI() {
            const loggedIn = !!currentUser;
            dom.pointsCounter.textContent = loggedIn ? (currentUser.points || 0) : '0';
            dom.loginBtn.innerHTML = loggedIn ? '<i class="fas fa-sign-out-alt"></i>退出' : '<i class="fas fa-sign-in-alt"></i>登录';
            dom.checkinBtn.disabled = !loggedIn;
            dom.generateBtn.disabled = !loggedIn;
            dom.favoriteBtn.disabled = true;
            dom.userEmailDisplay.style.display = loggedIn ? 'flex' : 'none';

            const currentMode = document.querySelector('input[name="generation-type"]:checked').value;
            dom.accountBatchContainer.style.display = (loggedIn && currentMode === 'account') ? 'block' : 'none';
            dom.nameBatchContainer.style.display = (loggedIn && currentMode === 'name') ? 'block' : 'none';

            if (loggedIn) {
                const emailUsername = currentUser.email.split('@')[0];
                dom.headerAvatar.src = currentUser.avatarUrl || DEFAULT_AVATAR_SVG;
                dom.headerAvatar.onerror = () => { dom.headerAvatar.src = DEFAULT_AVATAR_SVG; };
                const today = new Date().toDateString();
                const alreadyCheckedIn = currentUser.lastCheckin === today;
                dom.checkinBtn.disabled = alreadyCheckedIn;
                dom.checkinBtn.innerHTML = alreadyCheckedIn ? '<i class="fas fa-calendar-check"></i>今日已签到' : '<i class="fas fa-calendar-check"></i>每日签到';
            }
            updateFavoriteUI(dom.resultDisplay.textContent);
            loadHistory();
            loadFavorites();
        }

        async function loadRemoteData() {
            if (!currentUser) return;
            const doc = await db.collection("users").doc(currentUser.uid).get();
            if (doc.exists) {
                const data = doc.data();
                currentUser = { ...currentUser, ...data };
            }
            if (typeof currentUser.points !== 'number') currentUser.points = 0;
            history = currentUser.history || [];
            favorites = currentUser.favorites || [];
        }
        
        function setupEventListeners() {
            dom.loginBtn.addEventListener('click', () => { if (currentUser) auth.signOut(); else dom.authModal.classList.add('active'); });
            dom.headerAvatar.addEventListener('click', (e) => { e.stopPropagation(); showUserInfoModal(true); });
            dom.userEmailText.addEventListener('click', (e) => { e.stopPropagation(); showUserInfoModal(false); });
            dom.saveAvatarUrlBtn.addEventListener('click', handleAvatarUrlSave);
            dom.switchModeBtn.addEventListener('click', toggleAuthMode);
            dom.authSubmitBtn.addEventListener('click', handleAuthSubmit);
            dom.generateBtn.addEventListener('click', handleGenerate);
            dom.batchGenerateBtn.addEventListener('click', batchGenerateAccounts);
            dom.nameBatchGenerateBtn.addEventListener('click', batchGenerateNames);
            dom.copyBtn.addEventListener('click', () => copyToClipboard(dom.resultDisplay.textContent));
            dom.favoriteBtn.addEventListener('click', () => toggleFavorite(dom.resultDisplay.textContent));
            dom.clearHistoryBtn.addEventListener('click', () => clearList('history'));
            dom.clearFavoritesBtn.addEventListener('click', () => clearList('favorites'));
            dom.checkinBtn.addEventListener('click', checkin);
            dom.copyAllBtn.addEventListener('click', copyAllAccounts);
            dom.closeBatchBtn.addEventListener('click', () => dom.batchResults.style.display = 'none');
            document.querySelectorAll('.close-modal').forEach(btn => btn.addEventListener('click', (e) => e.target.closest('.modal').classList.remove('active')));
            document.querySelectorAll('.tab').forEach(tab => tab.addEventListener('click', (e) => { document.querySelector('.tab.active').classList.remove('active'); document.querySelector('.tab-content.active').classList.remove('active'); e.currentTarget.classList.add('active'); document.getElementById(`${e.currentTarget.dataset.tab}-content`).classList.add('active'); }));
            document.addEventListener('click', e => { if (e.target.closest('.icon-btn.favorite')) toggleFavorite(e.target.closest('.icon-btn').dataset.account); if (e.target.closest('.icon-btn.copy')) copyToClipboard(e.target.closest('.icon-btn').dataset.account); });
            
            dom.generationTypeRadios.forEach(radio => radio.addEventListener('change', toggleGeneratorMode));
        }
        
        function toggleGeneratorMode(event) {
            const mode = event.target.value;
            if (mode === 'account') {
                dom.accountOptions.style.display = 'block';
                dom.nameOptions.style.display = 'none';
            } else {
                dom.accountOptions.style.display = 'none';
                dom.nameOptions.style.display = 'block';
            }
            dom.resultDisplay.textContent = PLACEHOLDER_TEXT;
            updateUI();
        }

        async function handleGenerate() {
            const mode = document.querySelector('input[name="generation-type"]:checked').value;
            if (mode === 'account') {
                await generateAccount();
            } else {
                await generateName();
            }
        }

        function showUserInfoModal(focusOnAvatarInput = false) {
            if (!currentUser) return;
            document.getElementById('user-email').textContent = currentUser.email || 'N/A';
            document.getElementById('user-join-date').textContent = currentUser.joinDate ? new Date(currentUser.joinDate).toLocaleDateString() : '未知';
            document.getElementById('user-points').textContent = currentUser.points || 0;
            dom.avatarUrlInput.value = currentUser.avatarUrl || '';
            dom.userInfoModal.classList.add('active');
            if (focusOnAvatarInput) {
                setTimeout(() => dom.avatarUrlInput.focus(), 100);
            }
        }

        async function handleAvatarUrlSave() {
            if (!currentUser) return;
            const newUrl = dom.avatarUrlInput.value.trim();
            if (newUrl && !newUrl.startsWith('http')) return showNotification('请输入一个有效的URL链接', 'error');
            try {
                await db.collection('users').doc(currentUser.uid).update({ avatarUrl: newUrl });
                currentUser.avatarUrl = newUrl;
                updateUI();
                dom.userInfoModal.classList.remove('active');
                showNotification('头像链接已更新!');
            } catch (error) {
                showNotification('更新失败，请重试', 'error');
            }
        }
        
        async function recordLoginInfo(uid) {
            try {
                const response = await fetch('https://api.ipify.org?format=json');
                const data = await response.json();
                if (data.ip) {
                    await db.collection('users').doc(uid).update({ lastLoginIp: data.ip, lastLoginDate: new Date().toISOString() });
                }
            } catch (error) {
                console.error("无法记录用户登录信息:", error);
            }
        }
        
        async function handleAuthSubmit() {
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value;
            const isLogin = dom.authSubmitBtn.textContent === '登录';
            if (!username || !password) return showNotification('请输入邮箱和密码', 'error');
            if (!isLogin && password !== document.getElementById('confirm-password').value) return showNotification('两次输入的密码不一致', 'error');
            dom.authSubmitBtn.disabled = true;
            try {
                if (isLogin) {
                    const userCredential = await auth.signInWithEmailAndPassword(username, password);
                    await recordLoginInfo(userCredential.user.uid);
                } else {
                    const userCredential = await auth.createUserWithEmailAndPassword(username, password);
                    await db.collection('users').doc(userCredential.user.uid).set({ email: userCredential.user.email, history: [], favorites: [], points: 1000, joinDate: new Date().toISOString(), lastCheckin: null, avatarUrl: null, lastLoginIp: null, lastLoginDate: null }, { merge: true });
                }
                dom.authModal.classList.remove('active');
                showNotification(isLogin ? '登录成功' : '注册成功');
            } catch (error) {
                showNotification(error.message, 'error');
            } finally {
                dom.authSubmitBtn.disabled = false;
            }
        }
        
        async function fetchWordLibrary(url) { try { const r = await fetch(url); if (!r.ok) { console.error(`Failed to fetch ${url}, status: ${r.status}`); return null; } return await r.json(); } catch(e) { console.error(`Error fetching or parsing ${url}:`, e); return null; } }
        
        async function loadWordLibraries() { 
            [chineseWords, englishWords, femaleNames, maleNames, familyNames] = await Promise.all([
                fetchWordLibrary(CHINESE_WORDS_URL).then(data => data || DEFAULT_CHINESE_WORDS),
                fetchWordLibrary(ENGLISH_WORDS_URL).then(data => data || DEFAULT_ENGLISH_WORDS),
                fetchWordLibrary(FEMALE_NAME_URL).then(data => data || DEFAULT_FEMALE_NAMES),
                fetchWordLibrary(MALE_NAME_URL).then(data => data || DEFAULT_MALE_NAMES),
                fetchWordLibrary(FAMILY_NAME_URL).then(data => data || DEFAULT_FAMILY_NAMES)
            ]);
        }
        
        function getUniqueRandomWord(wordList, type) {
            if (!wordList || wordList.length === 0) return '';
            if (!recentlyUsed[type]) recentlyUsed[type] = [];

            let word;
            let attempts = 0;
            const maxAttempts = 10;

            do {
                word = wordList[Math.floor(Math.random() * wordList.length)];
                attempts++;
            } while (recentlyUsed[type].includes(word) && attempts < maxAttempts && wordList.length > RECENT_LIST_SIZE);
            
            recentlyUsed[type].unshift(word);
            if (recentlyUsed[type].length > RECENT_LIST_SIZE) recentlyUsed[type].pop();
            return word;
        }

        function resetLocalData() { history = []; favorites = []; dom.resultDisplay.textContent = PLACEHOLDER_TEXT; }
        function renderList(listEl, accounts, type) { listEl.innerHTML = ''; if (accounts.length === 0) { listEl.innerHTML = `<li class="history-item"><span>暂无${type}</span></li>`; return; } accounts.forEach(item => { const isFavorite = favorites.includes(item); const li = document.createElement('li'); li.className = 'history-item'; li.innerHTML = `<span>${item}</span><div class="history-actions"><button class="icon-btn favorite" data-account="${item}"><i class="${isFavorite ? 'fas' : 'far'} fa-heart"></i></button><button class="icon-btn copy" data-account="${item}"><i class="fas fa-copy"></i></button></div>`; listEl.appendChild(li); }); }
        function loadHistory() { renderList(dom.historyList, history, '历史记录'); }
        function loadFavorites() { renderList(dom.favoritesList, favorites, '收藏'); }
        function toggleAuthMode() { const isLogin = dom.authSubmitBtn.textContent === '登录'; document.getElementById('modal-title').textContent = isLogin ? '用户注册' : '用户登录'; document.getElementById('confirm-password-group').style.display = isLogin ? 'block' : 'none'; dom.switchModeBtn.textContent = isLogin ? '返回登录' : '注册新账号'; dom.authSubmitBtn.textContent = isLogin ? '注册' : '登录'; }
        
        async function updatePointsInDb(amount) {
            if (!currentUser) { showNotification('请先登录', 'warning'); return false; }
            const currentPoints = typeof currentUser.points === 'number' ? currentUser.points : 0;
            if (currentPoints < amount) { showNotification(`积分不足`, 'warning'); return false; }
            currentUser.points = currentPoints - amount;
            updateUI();
            await db.collection('users').doc(currentUser.uid).update({ points: currentUser.points });
            return true;
        }
        
        function generateRandomAccountString() {
            let parts = [];
            if (dom.chineseCheckbox.checked) parts.push(getUniqueRandomWord(chineseWords, 'chinese'));
            if (dom.englishCheckbox.checked) parts.push(getUniqueRandomWord(englishWords, 'english'));
            if (dom.numbersCheckbox.checked) parts.push(Math.floor(Math.random() * 900) + 100);
            return parts.join('') || "请选择账号类型";
        }
        
        function generateRandomNameString() {
            const maleChecked = dom.nameMaleCheckbox.checked;
            const femaleChecked = dom.nameFemaleCheckbox.checked;
            const singleChecked = dom.nameSingleCheckbox.checked;
            const doubleChecked = dom.nameDoubleCheckbox.checked;

            if (!maleChecked && !femaleChecked && !singleChecked && !doubleChecked) {
                return "请至少选择一个姓名类型";
            }
            
            let nameList, genderType;
            if (maleChecked && !femaleChecked) { nameList = maleNames; genderType = 'male'; } 
            else if (!maleChecked && femaleChecked) { nameList = femaleNames; genderType = 'female'; } 
            else { if (Math.random() < 0.5) { nameList = maleNames; genderType = 'male'; } else { nameList = femaleNames; genderType = 'female'; } }
            
            let length;
            if (singleChecked && !doubleChecked) { length = 1; } 
            else if (!singleChecked && doubleChecked) { length = 2; } 
            else { length = Math.random() < 0.5 ? 1 : 2; }
            
            const familyName = getUniqueRandomWord(familyNames, 'family');
            let givenName = '';

            if (length === 1) {
                givenName = getUniqueRandomWord(nameList, genderType);
            } else {
                const name1 = getUniqueRandomWord(nameList, genderType);
                let name2 = getUniqueRandomWord(nameList, genderType);
                while (nameList.length > 1 && name1 === name2) {
                    name2 = getUniqueRandomWord(nameList, genderType);
                }
                givenName = name1 + name2;
            }
            return familyName + givenName;
        }

        async function generateAccount() {
            if (await updatePointsInDb(1)) {
                const account = generateRandomAccountString();
                dom.resultDisplay.textContent = account;
                await addToHistory(account);
                updateFavoriteUI(account);
                showNotification('账号已生成，消耗1积分');
            }
        }
        
        async function generateName() {
            if (await updatePointsInDb(1)) {
                const fullName = generateRandomNameString();
                if (fullName.startsWith("请至少")) {
                    showNotification(fullName, 'error');
                    await updatePointsInDb(-1); // Refund point
                    return;
                }
                dom.resultDisplay.textContent = fullName;
                await addToHistory(fullName);
                updateFavoriteUI(fullName);
                showNotification('姓名已生成，消耗1积分');
            }
        }
        
        async function batchGenerateAccounts() { const count = parseInt(dom.batchCountInput.value) || 5; if (await updatePointsInDb(count)) { const accounts = Array.from({ length: count }, generateRandomAccountString); showBatchResults(accounts); history = [...accounts, ...history.filter(h => !accounts.includes(h))].slice(0, 50); await saveUserDataToFirestore(); loadHistory(); showNotification(`已生成${count}个账号`); } }
        
        async function batchGenerateNames() {
            const count = parseInt(dom.nameBatchCountInput.value) || 5;
            if (await updatePointsInDb(count)) {
                const names = Array.from({ length: count }, generateRandomNameString);
                if(names[0] && names[0].startsWith("请至少")){
                    showNotification(names[0], 'error');
                    await updatePointsInDb(-count); // Refund all points
                    return;
                }
                showBatchResults(names);
                history = [...names, ...history.filter(h => !names.includes(h))].slice(0, 50);
                await saveUserDataToFirestore();
                loadHistory();
                showNotification(`已生成${count}个姓名`);
            }
        }
        
        async function addToHistory(item) { if (!currentUser || item === PLACEHOLDER_TEXT || item.startsWith("请选择") || item.startsWith("请至少")) return; history = [item, ...history.filter(h => h !== item)].slice(0, 50); await saveUserDataToFirestore(); loadHistory(); }
        
        function updateFavoriteUI(text) {
            const isInvalid = !currentUser || !text || text === PLACEHOLDER_TEXT || text.startsWith("请选择") || text.startsWith("请至少");
            dom.favoriteBtn.disabled = isInvalid;
            if (isInvalid) {
                dom.favoriteBtn.innerHTML = `<i class="far fa-heart"></i>收藏`;
                return;
            }
            const isFav = favorites.includes(text);
            dom.favoriteBtn.innerHTML = `<i class="${isFav ? 'fas' : 'far'} fa-heart"></i>${isFav ? '已收藏' : '收藏'}`;
        }
        
        async function toggleFavorite(text) { 
            if (!currentUser || !text || text === PLACEHOLDER_TEXT || text.startsWith("请选择") || text.startsWith("请至少")) return;
            const index = favorites.indexOf(text); 
            if (index > -1) favorites.splice(index, 1); 
            else favorites = [text, ...favorites].slice(0, 30); 
            await saveUserDataToFirestore(); 
            loadFavorites(); 
            loadHistory(); 
            updateFavoriteUI(text);
        }

        function copyToClipboard(text) { 
            if (!text || text === PLACEHOLDER_TEXT || text.startsWith("请选择") || text.startsWith("请至少")) { showNotification(`没有可复制的内容`, 'warning'); return; }
            navigator.clipboard.writeText(text).then(() => showNotification(`已复制到剪贴板`)); 
        }

        function copyAllAccounts() { const text = Array.from(dom.generatedAccounts.querySelectorAll('.history-item span')).map(el => el.textContent).join('\n'); copyToClipboard(text); }
        async function clearList(type) { 
            if (!currentUser) return showNotification('请先登录', 'warning');
            const name = type === 'history' ? '历史记录' : '收藏'; 
            if (confirm(`确定清空${name}吗？`)) { 
                if (type === 'history') history = []; else favorites = []; 
                await saveUserDataToFirestore(); 
                type === 'history' ? loadHistory() : loadFavorites(); 
                showNotification(`${name}已清空`); 
            } 
        }
        async function checkin() { 
            if (!currentUser) return showNotification('请先登录', 'warning');
            currentUser.points = (typeof currentUser.points === 'number' ? currentUser.points : 0) + 1000; 
            currentUser.lastCheckin = new Date().toDateString(); 
            await db.collection('users').doc(currentUser.uid).update({ points: currentUser.points, lastCheckin: currentUser.lastCheckin }); 
            updateUI(); 
            showNotification('签到成功，获得1000积分'); 
        }
        async function saveUserDataToFirestore() { if (!currentUser) return; await db.collection('users').doc(currentUser.uid).update({ history: history, favorites: favorites }); }
        function showBatchResults(accounts) { dom.generatedAccounts.innerHTML = ''; accounts.forEach(account => { const isFav = favorites.includes(account); const div = document.createElement('div'); div.className = 'history-item'; div.innerHTML = `<span>${account}</span><div class="history-actions"><button class="icon-btn favorite" data-account="${account}"><i class="${isFav ? 'fas' : 'far'} fa-heart"></i></button><button class="icon-btn copy" data-account="${account}"><i class="fas fa-copy"></i></button></div>`; dom.generatedAccounts.appendChild(div); }); dom.batchResults.style.display = 'block'; }
        function showNotification(message, type = 'success') { dom.notificationText.textContent = message; dom.notification.className = 'notification'; dom.notification.classList.add(type, 'show'); setTimeout(() => dom.notification.classList.remove('show'), 3000); }
        
        init();
    </script>
</body>
</html>
